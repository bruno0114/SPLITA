---
phase: 11
plan: 1
wave: 1
---

# Plan 11.1: Categories Database & Sync Hook

## Objective
Migrate category management from hardcoded constants to a dynamic Supabase-backed system. This enables user-defined categories, custom colors, and AI auto-creation.

## Context
- .gsd/SPEC.md
- .gsd/ROADMAP.md
- .gsd/phases/11/RESEARCH.md
- src/lib/constants.ts (current hardcoded categories)
- src/types/index.ts (type definitions)

## Tasks

<task type="auto">
  <name>Create Categories Table</name>
  <files>
    - .gsd/phases/11/migrations/01_create_categories.sql
  </files>
  <action>
    Define the SQL schema for `categories`:
    - `id`: UUID (PK, default gen_random_uuid())
    - `user_id`: UUID (FK to auth.users, nullable for system categories)
    - `name`: TEXT (Unique per user/system)
    - `icon`: TEXT (Lucide icon name)
    - `color`: TEXT (Tailwind text class)
    - `bg_color`: TEXT (Tailwind bg class)
    - `is_system`: BOOLEAN (default false)
    - RLS: Enable RLS. Users can only SELECT (user_id = auth.uid() OR is_system = true) and INSERT/UPDATE/DELETE (user_id = auth.uid()).
    Apply this via `apply_migration`.
  </action>
  <verify>Check table existence and RLS with `supabase-mcp-server` tool or direct SQL query.</verify>
  <done>Table `categories` exists with correct columns and RLS policies.</done>
</task>

<task type="auto">
  <name>Implement useCategories Hook</name>
  <files>
    - src/features/analytics/hooks/useCategories.ts
    - src/types/index.ts
  </files>
  <action>
    Create a custom hook `useCategories` to manage the category lifecycle:
    - `categories`: State containing synced categories.
    - `fetchCategories`: Fetch user and system categories.
    - `addCategory`: Insert a new category.
    - `updateCategory`: Update existing.
    - `deleteCategory`: Remove user category.
    - Handle loading and error states.
    - Seed system categories from `CATEGORY_CONFIG` if the DB is empty.
  </action>
  <verify>Run a smoke test component or check types with `tsc`.</verify>
  <done>Hook correctly fetches and manages category state from Supabase.</done>
</task>

## Success Criteria
- [ ] Supabase has a `categories` table with proper RLS.
- [ ] `useCategories` hook provides real-time access to user/system categories.
- [ ] Existing categories from `constants.ts` are ready to be seeded/migrated.
