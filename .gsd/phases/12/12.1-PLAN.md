---
phase: 12
plan: 1
wave: 1
---

# Plan 12.1: Per-User Categorization & Schema

## Objective
Enable users to categorize their share of group expenses independently and establish the database schema for AI caching.

## Context
- .gsd/SPEC.md
- src/features/dashboard/hooks/usePersonalTransactions.ts
- src/features/groups/hooks/useGroups.ts

## Tasks

<task type="auto">
  <name>Migration: Update Schema</name>
  <files>
    .gsd/phases/12/migrations/001_add_split_category_and_insights.sql
  </files>
  <action>
    Create a SQL migration file that:
    1. Adds 'category' column to 'transaction_splits' (nullable).
    2. Updates existing splits to inherit category from parent 'transactions'.
    3. Creates 'daily_insights' table with (id, user_id, date, content, created_at).
    4. Enable RLS on 'daily_insights'.
    Execute this migration using the execute_sql tool.
  </action>
  <verify>
    Check columns exist using supabase-mcp-server tool or SQL query.
  </verify>
  <done>
    Schema updated and verified.
  </done>
</task>

<task type="auto">
  <name>Backend: Update Hooks</name>
  <files>
    src/features/dashboard/hooks/usePersonalTransactions.ts
    src/features/expenses/hooks/useTransactions.ts
  </files>
  <action>
    1. Update 'usePersonalTransactions' to fetch 'category' from 'transaction_splits' if it exists, otherwise fallback to transaction category.
    2. Update 'useTransactions' (add/update) to optionally save category to splits.
    3. Create/Update 'updateSplitCategory' function in 'useTransactions' to allow updating JUST the split category.
  </action>
  <verify>
    Verify hook builds and logical flow.
  </verify>
  <done>
    Hooks updated to support split-level categorization.
  </done>
</task>

<task type="auto">
  <name>UI: Transaction Card Categorization</name>
  <files>
    src/features/expenses/components/TransactionCard.tsx
    src/features/dashboard/pages/PersonalFinance.tsx
  </files>
  <action>
    Modify 'TransactionCard' to allow changing the category when the transaction is a 'split' (is_group context).
    Instead of editing the whole transaction, it should call the new 'updateSplitCategory' function.
  </action>
  <verify>
    Browser or code review: changing category on a split card changes it locally.
  </verify>
  <done>
    UI supports per-user recategorization.
  </done>
</task>

## Success Criteria
- [ ] 'transaction_splits' has category data.
- [ ] Users can see their own categories for group splits in Personal Finance.
- [ ] 'daily_insights' table exists.
