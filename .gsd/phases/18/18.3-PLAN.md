---
phase: 18
plan: 3
wave: 1
---

# Plan 18.3: Join Flow Polish & Debug

## Objective
Fix the "Join Group" flow where unauthenticated users see the internal dashboard layout, and resolve the screen flickering/blinking issue during redirects.

## Context
- .gsd/SPEC.md
- .gsd/DEBUG.md
- src/App.tsx
- src/features/groups/pages/JoinGroup.tsx

## Tasks

<task type="auto">
  <name>Refactor App Layout for Join Route</name>
  <files>src/App.tsx</files>
  <action>
    - Extract the Authenticated Layout (Sidebar, Header, BottomNav, Main) into a wrapper component/layout.
    - Update `App.tsx` handling of `isAuthRoute` to include `/unirse/*` paths as "Standalone" routes (similar to Login/Onboarding).
    - Ensure `/unirse/:inviteCode` renders WITHOUT the main dashboard shell.
  </action>
  <verify>
    browse("/") -> Login (Standalone)
    browse("/unirse/test-code") -> JoinGroup (Standalone, no sidebar)
    browse("/dashboard") -> Dashboard (Full Layout)
  </verify>
  <done>
    - Unauthenticated access to /unirse/:code shows ONLY the JoinGroup component.
    - No Sidebar or Header visible on Join screen.
  </done>
</task>

<task type="auto">
  <name>Redesign JoinGroup UI</name>
  <files>src/features/groups/pages/JoinGroup.tsx</files>
  <action>
    - Update component to match the "Onboarding" aesthetic (Clean, centered card, dynamic background).
    - Remove "Volver a mis grupos" link if user is NOT authenticated.
    - Improve "Login" flow:
      - If user clicks "Join" and is not logged in -> Redirect to Login with `state: { from: location }` or `returnUrl` query param instead of relying solely on generic localStorage if possible, or refine the localStorage usage to be seamless.
    - Display Group Info clearly (Avatar, Name, Member count).
  </action>
  <verify>
    Visual check of the UI compared to Login/Onboarding style.
  </verify>
  <done>
    - UI matches the design proposal in DEBUG.md.
    - "Join" action handles unauthenticated state gracefully.
  </done>
</task>

<task type="auto">
  <name>Fix Redirect Flickering</name>
  <files>src/App.tsx, src/features/auth/context/AuthContext.tsx</files>
  <action>
    - Investigate usage of `App.tsx`'s `useEffect` for `syncOnboarding` vs `redirectPath`.
    - Prevent the component from rendering the "Default/Dashboard" route while checking for redirects.
    - Use a "Loading/Splash" state in `App.tsx` while strictly determining if a redirect is needed (e.g. `splita_redirect_path` in localStorage).
    - Ensure `useAuth` loading state blocks the main router render until auth is confirmed, preventing the flash of "Public" vs "Private" route content.
  </action>
  <verify>
    - Clear localStorage.
    - Open /unirse/test-code (unauthenticated).
    - Login.
    - Observe smooth transition without "double blink".
  </verify>
  <done>
    - Login redirect flow is smooth.
    - No UI flashes of incorrect state.
  </done>
</task>

## Success Criteria
- [ ] Users visiting invte links sees a clean, standalone page.
- [ ] No dashboard chrome (sidebar/header) visible for guests.
- [ ] Login -> Redirect back to join flow is smooth and functional.
