---
phase: 18
plan: 2
wave: 1
---

# Plan 18.2: Fix Invite Auth & Onboarding

## Objective
Ensure that users returning from authentication (OAuth or Email flow) are reliably redirected back to the invite link (`/unirse/:code`), preserving all URL parameters.

## Context
- `src/App.tsx`: Global auth redirect logic.
- `src/features/groups/pages/JoinGroup.tsx`: Invite entry point.
- `src/features/auth/pages/Login.tsx`: OAuth configuration.

## Tasks

<task type="auto">
  <name>Update JoinGroup with Full Path Persistence</name>
  <files>src/features/groups/pages/JoinGroup.tsx</files>
  <action>
    Modify `handleJoin` in `JoinGroup.tsx`.
    1. If `!user`:
       - Construct full path: `const target = location.pathname + location.search + location.hash;`
       - `localStorage.setItem('splita_redirect_path', target)`
       - `navigate(AppRoute.LOGIN)`
  </action>
  <verify>Check persistence uses full URL.</verify>
  <done>JoinGroup saves full intent.</done>
</task>

<task type="auto">
  <name>Implement Robust Redirect in App</name>
  <files>src/App.tsx</files>
  <action>
    Add effect in `App.tsx` for `useAuthContext`.
    1. Logic:
       - Check `localStorage.getItem('splita_redirect_path')`.
       - **Guard**: Only proceed if `user` (session) is valid.
       - **Loop Guard**: Construct `current = location.pathname + location.search + location.hash`.
       - If `current === targetPath`, do NOT redirect (just clear storage).
       - **Redirect**: `navigate(targetPath, { replace: true })`.
       - **Cleanup**: `localStorage.removeItem('splita_redirect_path')` (only if redirected or guard hit).
    2. **Email Confirmation Note**: Ensure storage is NOT cleared if `user` is null.
  </action>
  <verify>Check App.tsx effect logic.</verify>
  <done>App restores navigation safely.</done>
</task>

<task type="auto">
  <name>Verify OAuth Config</name>
  <files>src/features/auth/pages/Login.tsx, src/features/auth/pages/Onboarding.tsx</files>
  <action>
    Ensure OAuth calls use `redirectTo: window.location.origin`.
    - Verification only: No changes if already correct.
  </action>
  <verify>Confirm redirectTo matches origin.</verify>
  <done>OAuth config confirmed.</done>
</task>

<task type="auto">
  <name>Enhance JoinUX (Return User)</name>
  <files>src/features/groups/pages/JoinGroup.tsx</files>
  <action>
    UX Polish for returning users:
    - Ensure "Unirme" button is enabled immediately when `user` becomes defined.
    - Ensure `fetchInviteGroup` triggers correctly on mount/auth-update.
  </action>
  <verify>Review dependency arrays.</verify>
  <done>Join flow robust for returning users.</done>
</task>

## Success Criteria
- [ ] Logic preserves query params and hash.
- [ ] Redirect uses `replace: true` to clean history.
- [ ] Loop guard prevents infinite redirects by comparing FULL URL.
- [ ] Path persists until valid session is established.
