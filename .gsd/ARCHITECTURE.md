# Architecture

> Auto-generated by /map on 2026-01-19

## Overview

SPLITA is a financial management PWA for personal finance tracking and group expense splitting. Built with React 19, TypeScript, and Supabase backend.

```
┌─────────────────────────────────────────────────────┐
│                    App.tsx (Router)                 │
│           Theme, Currency, Navigation State         │
├─────────────────────────────────────────────────────┤
│  AuthProvider     │  Layout Components              │
│  (Supabase Auth)  │  Sidebar, Header, BottomNav     │
├───────────────────┴─────────────────────────────────┤
│                  Feature Modules                    │
│  ┌─────────┬─────────┬─────────┬─────────┬───────┐ │
│  │  auth   │dashboard│ groups  │expenses │settings│ │
│  │ context │ pages   │ hooks   │ hooks   │ hooks  │ │
│  │ hooks   │ hooks   │ pages   │ pages   │ pages  │ │
│  │ pages   │         │         │         │        │ │
│  └─────────┴─────────┴─────────┴─────────┴───────┘ │
├─────────────────────────────────────────────────────┤
│                  Data Layer                         │
│    supabase.ts  │  Custom Hooks  │  Types           │
└─────────────────────────────────────────────────────┘
                          │
                          ▼
              ┌───────────────────────┐
              │   Supabase Backend    │
              │  PostgreSQL + Auth    │
              │       + RLS           │
              └───────────────────────┘
```

## Feature Modules

### auth
- **Purpose:** Authentication, onboarding, login
- **Location:** `src/features/auth/`
- **Components:**
  - `AuthContext.tsx` - Global auth state provider
  - `useAuth.ts` - Auth actions hook
  - `Login.tsx` - Email/OAuth login page
  - `Onboarding.tsx` - 6-step new user flow
  - `ProtectedRoute.tsx` - Route guard

### dashboard
- **Purpose:** Personal finance views
- **Location:** `src/features/dashboard/`
- **Components:**
  - `PersonalFinance.tsx` - Balance, transactions list
  - `EconomicHealth.tsx` - Financial health score
  - `usePersonalTransactions.ts` - CRUD for personal_transactions
  - `useEconomicHealth.ts` - Score calculation

### groups
- **Purpose:** Group expense management
- **Location:** `src/features/groups/`
- **Components:**
  - `Groups.tsx` - Group list with create modal
  - `GroupDetails.tsx` - Single group view
  - `useGroups.ts` - CRUD for groups/group_members

### expenses
- **Purpose:** Shared expense tracking + AI import
- **Location:** `src/features/expenses/`
- **Components:**
  - `ImportExpenses.tsx` - Multi-step UI for receipt uploading and AI validation
  - `useTransactions.ts` - Group transactions CRUD with split logic
- **AI Integration:** Offloaded to `src/services/ai.ts` (extractExpensesFromImages)

### settings
- **Purpose:** User profile and preferences
- **Location:** `src/features/settings/`
- **Components:**
  - `Settings.tsx` - Main settings hub
  - `AISettings.tsx` - **Gemini API Key management** (validation, persistence, removal)
  - `useProfile.ts` - Profile CRUD (Avatar + API Keys)

## Data Flow

1. **Authentication:** `AuthProvider` checks Supabase session → sets global user state
2. **Protected Routes:** `ProtectedRoute` checks auth → redirects if not authenticated
3. **Feature Hooks:** Each feature has hooks that fetch from Supabase with RLS
4. **Real-time Updates:** Hooks use `useEffect` to fetch on mount/user change

## Integration Points

| Service | Type | Purpose |
|---------|------|---------|
| Supabase Auth | OAuth + Email | User authentication |
| Supabase Database | PostgreSQL | Data persistence |
| Google Gemini | AI API | Receipt/invoice scanning |
| DolarAPI | REST API | Real-time exchange rates |

## Database Tables

| Table | Purpose | RLS Logic |
|-------|---------|-----------|
| profiles | User profiles + Keys | self-update, anyone can read basic info |
| groups | Expense groups | member-only access |
| group_members | Group membership | member-only read/write |
| transactions | Group transactions | member-only read/write |
| transaction_splits | Who owes what | member-only read/write |
| personal_transactions | Personal finance | owner-only access |
| user_settings | Preferences | owner-only access |

## Core Logic Flows

### 1. Group Creation Flow
1. User submits name/type in `Groups.tsx`.
2. `useGroups.ts` inserts new record into `groups`.
3. Database trigger or second client call (manual) inserts creator into `group_members` with `role: 'admin'`.
4. RLS allows subsequent access because user is now in `group_members`.

### 2. AI Receipt Import Flow
1. User uploads files in `ImportExpenses.tsx`.
2. Component calls `extractExpensesFromImages` in `ai.ts`.
3. AI Service:
   - Discovers best model (Flash vs Pro) based on user key region.
   - Performs smoke test (capability check).
   - Caches model for session efficiency.
   - Returns structured JSON array of expenses.
4. User selects group for import (personal vs group context determines `group_id` presence).
5. Transactions + Splits are batch-inserted into Supabase.

## Technical Debt

- [ ] Group invitations (pending members) not implemented
- [x] Avatar upload with WebP compression (**COMPLETED**)
- [ ] Real-time activity feed placeholder
- [ ] Group balance calculation (Simplistic equal split, needs complex logic for custom splits)
- [ ] No automated tests

## Conventions

- **Naming:** PascalCase components, camelCase hooks/functions
- **Structure:** Feature-based with pages/hooks/components subdirs
- **State:** React hooks + Supabase real-time
- **Styling:** Tailwind CSS + custom glassmorphism classes
